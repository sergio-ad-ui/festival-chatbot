<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Appartamenti - ConnyUp Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
        }
        .nav-tabs .nav-link.active {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .apartment-selector {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .quick-action-btn {
            margin: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-house-door text-success"></i> Admin Appartamenti</h1>
                <p class="text-muted">Gestisci le informazioni per gli ospiti degli appartamenti turistici</p>
            </div>
            <div>
                <a href="/admin" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Torna alla Dashboard
                </a>
            </div>
        </div>

        <!-- Apartment Selector -->
        <div class="apartment-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4><i class="bi bi-geo-alt"></i> Seleziona Appartamento</h4>
                    <select class="form-select" id="apartment-selector" onchange="changeApartment()">
                        <option value="apt_brescia">üè† Appartamento Smeraldo - Brescia</option>
                        <option value="apt_milano">üè¢ Loft Navigli - Milano (Coming Soon)</option>
                        <option value="apt_roma">üèõÔ∏è Casa Trastevere - Roma (Coming Soon)</option>
                    </select>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-light btn-sm quick-action-btn" onclick="generateQR()">
                        <i class="bi bi-qr-code"></i> QR Code
                    </button>
                    <button class="btn btn-light btn-sm quick-action-btn" onclick="testBot()">
                        <i class="bi bi-chat-text"></i> Test Bot
                    </button>
                    <button class="btn btn-light btn-sm quick-action-btn" onclick="viewStats()">
                        <i class="bi bi-graph-up"></i> Statistiche
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-panel" type="button" role="tab">
                    <i class="bi bi-info-circle"></i> Info Appartamento
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-panel" type="button" role="tab">
                    <i class="bi bi-geo"></i> Servizi Locali
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="smart-home-tab" data-bs-toggle="tab" data-bs-target="#smart-home-panel" type="button" role="tab">
                    <i class="bi bi-house-gear"></i> Smart Home
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images-panel" type="button" role="tab">
                    <i class="bi bi-images"></i> Immagini
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="conversations-tab" data-bs-toggle="tab" data-bs-target="#conversations-panel" type="button" role="tab">
                    <i class="bi bi-chat-dots"></i> Conversazioni
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3">
            <!-- Info Appartamento Tab -->
            <div class="tab-pane fade show active" id="info-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-info-circle"></i> Informazioni Appartamento</h5>
                        <button class="btn btn-success btn-sm" onclick="addApartmentInfo()">
                            <i class="bi bi-plus"></i> Aggiungi Info
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="apartment-info-list">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Servizi Locali Tab -->
            <div class="tab-pane fade" id="services-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-geo"></i> Servizi Locali</h5>
                        <button class="btn btn-success btn-sm" onclick="addLocalService()">
                            <i class="bi bi-plus"></i> Aggiungi Servizio
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Service Type Filter -->
                        <div class="mb-3">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="service-filter" id="all-services" autocomplete="off" checked>
                                <label class="btn btn-outline-success" for="all-services">Tutti</label>
                                
                                <input type="radio" class="btn-check" name="service-filter" id="restaurants" autocomplete="off">
                                <label class="btn btn-outline-success" for="restaurants">Ristoranti</label>
                                
                                <input type="radio" class="btn-check" name="service-filter" id="supermarkets" autocomplete="off">
                                <label class="btn btn-outline-success" for="supermarkets">Supermercati</label>
                                
                                <input type="radio" class="btn-check" name="service-filter" id="pharmacies" autocomplete="off">
                                <label class="btn btn-outline-success" for="pharmacies">Farmacie</label>
                                
                                <input type="radio" class="btn-check" name="service-filter" id="attractions" autocomplete="off">
                                <label class="btn btn-outline-success" for="attractions">Attrazioni</label>
                            </div>
                        </div>
                        
                        <div id="local-services-list">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Home Tab -->
            <div class="tab-pane fade" id="smart-home-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-house-gear"></i> Dispositivi Smart Home</h5>
                        <button class="btn btn-success btn-sm" onclick="addSmartDevice()">
                            <i class="bi bi-plus"></i> Aggiungi Dispositivo
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="smart-devices-list">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images Tab -->
            <div class="tab-pane fade" id="images-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-images"></i> Immagini Appartamento</h5>
                    </div>
                    <div class="card-body">
                        <div id="apartment-images-list">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversazioni Tab -->
            <div class="tab-pane fade" id="conversations-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-chat-dots"></i> Conversazioni Recenti</h5>
                    </div>
                    <div class="card-body">
                        <div id="conversations-list">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Forms -->
    <!-- Apartment Info Modal -->
    <div class="modal fade" id="apartmentInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestisci Informazione Appartamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="apartment-info-form">
                        <input type="hidden" id="info-id">
                        <div class="mb-3">
                            <label for="info-category" class="form-label">Categoria</label>
                            <select class="form-select" id="info-category" required>
                                <option value="">Seleziona categoria...</option>
                                <option value="check_in">Check-in</option>
                                <option value="check_out">Check-out</option>
                                <option value="wifi">WiFi</option>
                                <option value="regole_casa">Regole della Casa</option>
                                <option value="servizi_inclusi">Servizi Inclusi</option>
                                <option value="parcheggio">Parcheggio</option>
                                <option value="emergenze">Emergenze</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="info-content" class="form-label">Contenuto</label>
                            <textarea class="form-control" id="info-content" rows="6" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="info-priority" class="form-label">Priorit√†</label>
                            <input type="number" class="form-control" id="info-priority" value="0" min="0" max="10">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveApartmentInfo()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Local Service Modal -->
    <div class="modal fade" id="localServiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestisci Servizio Locale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="local-service-form">
                        <input type="hidden" id="service-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-type" class="form-label">Tipo</label>
                                    <select class="form-select" id="service-type" required>
                                        <option value="">Seleziona tipo...</option>
                                        <option value="restaurant">Ristorante</option>
                                        <option value="cafe">Bar/Caff√®</option>
                                        <option value="supermarket">Supermercato</option>
                                        <option value="pharmacy">Farmacia</option>
                                        <option value="attraction">Attrazione</option>
                                        <option value="transport">Trasporti</option>
                                        <option value="other">Altro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-name" class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="service-name" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="service-description" class="form-label">Descrizione</label>
                            <textarea class="form-control" id="service-description" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-address" class="form-label">Indirizzo</label>
                                    <input type="text" class="form-control" id="service-address">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-distance" class="form-label">Distanza</label>
                                    <input type="text" class="form-control" id="service-distance" placeholder="es. 5 minuti a piedi">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-phone" class="form-label">Telefono</label>
                                    <input type="tel" class="form-control" id="service-phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service-rating" class="form-label">Valutazione (1-5)</label>
                                    <input type="number" class="form-control" id="service-rating" min="1" max="5" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="service-hours" class="form-label">Orari</label>
                            <input type="text" class="form-control" id="service-hours" placeholder="es. 9:00-18:00">
                        </div>
                        <div class="mb-3">
                            <label for="service-maps-url" class="form-label">Link Google Maps</label>
                            <input type="url" class="form-control" id="service-maps-url">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveLocalService()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Device Modal (created dynamically) -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentApartment = 'apt_brescia';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadApartmentInfo();
            loadLocalServices();
            loadSmartDevices();
            loadConversations();
        });

        function changeApartment() {
            currentApartment = document.getElementById('apartment-selector').value;
            // Reload all data for new apartment
            loadApartmentInfo();
            loadLocalServices();
            loadSmartDevices();
            loadConversations();
        }

        function generateQR() {
            const text = currentApartment === 'apt_brescia' ? 'APT_BRESCIA_START' : `${currentApartment.toUpperCase()}_START`;
            const url = `https://wa.me/34644409180?text=${text}`;
            window.open(`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`, '_blank');
        }

        function testBot() {
            const text = currentApartment === 'apt_brescia' ? 'APT_BRESCIA_START' : `${currentApartment.toUpperCase()}_START`;
            const url = `https://wa.me/34644409180?text=${text}`;
            window.open(url, '_blank');
        }

        function viewStats() {
            // Future: Show apartment-specific statistics
            alert('Statistiche specifiche per appartamento in arrivo');
        }

        // Apartment Info Functions
        function addApartmentInfo() {
            // Clear form
            document.getElementById('apartment-info-form').reset();
            document.getElementById('info-id').value = '';
            new bootstrap.Modal(document.getElementById('apartmentInfoModal')).show();
        }

        function saveApartmentInfo() {
            const infoId = document.getElementById('info-id').value;
            const data = {
                category: document.getElementById('info-category').value,
                content: document.getElementById('info-content').value,
                priority: parseInt(document.getElementById('info-priority').value) || 0,
                context_code: currentApartment
            };
            
            if (infoId) {
                data._id = infoId;
            }
            
            fetch('/admin/api/apartment-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('apartmentInfoModal')).hide();
                    loadApartmentInfo();
                    showNotification('success', result.message);
                } else {
                    showNotification('error', 'Errore nel salvataggio');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showNotification('error', 'Errore di connessione');
            });
        }

        function loadApartmentInfo() {
            fetch('/admin/api/apartment-info')
                .then(response => response.json())
                .then(data => {
                    const infoList = document.getElementById('apartment-info-list');
                    infoList.innerHTML = '';
                    
                    if (data.length === 0) {
                        infoList.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Nessuna informazione disponibile. Aggiungi la prima!</div>';
                        return;
                    }
                    
                    const table = document.createElement('table');
                    table.className = 'table table-hover';
                    table.innerHTML = `
                        <thead class="table-success">
                            <tr>
                                <th>Categoria</th>
                                <th>Contenuto</th>
                                <th>Priorit√†</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    
                    const tbody = table.querySelector('tbody');
                    
                    data.forEach(info => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><span class="badge bg-success">${info.category}</span></td>
                            <td>${info.content.substring(0, 100)}${info.content.length > 100 ? '...' : ''}</td>
                            <td><span class="badge bg-secondary">${info.priority || 0}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editApartmentInfo('${info._id}')">
                                    <i class="bi bi-pencil"></i> Modifica
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteApartmentInfo('${info._id}')">
                                    <i class="bi bi-trash"></i> Elimina
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    infoList.appendChild(table);
                })
                .catch(error => {
                    console.error('Errore nel caricamento:', error);
                    document.getElementById('apartment-info-list').innerHTML = '<div class="alert alert-danger">Errore nel caricamento delle informazioni</div>';
                });
        }
        
        function editApartmentInfo(id) {
            fetch('/admin/api/apartment-info')
                .then(response => response.json())
                .then(data => {
                    const info = data.find(item => item._id === id);
                    if (info) {
                        document.getElementById('info-id').value = info._id;
                        document.getElementById('info-category').value = info.category;
                        document.getElementById('info-content').value = info.content;
                        document.getElementById('info-priority').value = info.priority || 0;
                        
                        new bootstrap.Modal(document.getElementById('apartmentInfoModal')).show();
                    }
                });
        }
        
        function deleteApartmentInfo(id) {
            if (confirm('Sei sicuro di voler eliminare questa informazione?')) {
                fetch(`/admin/api/apartment-info/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadApartmentInfo();
                        showNotification('success', result.message);
                    }
                });
            }
        }

        // Local Services Functions
        function addLocalService() {
            document.getElementById('local-service-form').reset();
            document.getElementById('service-id').value = '';
            new bootstrap.Modal(document.getElementById('localServiceModal')).show();
        }

        function saveLocalService() {
            const serviceId = document.getElementById('service-id').value;
            const data = {
                type: document.getElementById('service-type').value,
                name: document.getElementById('service-name').value,
                description: document.getElementById('service-description').value,
                address: document.getElementById('service-address').value,
                distance: document.getElementById('service-distance').value,
                phone: document.getElementById('service-phone').value,
                rating: parseFloat(document.getElementById('service-rating').value) || null,
                hours: document.getElementById('service-hours').value,
                maps_url: document.getElementById('service-maps-url').value,
                context_code: currentApartment
            };
            
            if (serviceId) {
                data._id = serviceId;
            }
            
            fetch('/admin/api/local-services', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('localServiceModal')).hide();
                    loadLocalServices();
                    showNotification('success', result.message);
                } else {
                    showNotification('error', 'Errore nel salvataggio');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showNotification('error', 'Errore di connessione');
            });
        }

        function loadLocalServices() {
            const serviceFilter = document.querySelector('input[name="service-filter"]:checked')?.id || 'all-services';
            const filterType = serviceFilter === 'all-services' ? 'all' : 
                             serviceFilter === 'restaurants' ? 'restaurant' :
                             serviceFilter === 'supermarkets' ? 'supermarket' :
                             serviceFilter === 'pharmacies' ? 'pharmacy' :
                             serviceFilter === 'attractions' ? 'attraction' : 'all';
                             
            fetch(`/admin/api/local-services?type=${filterType}`)
                .then(response => response.json())
                .then(data => {
                    const servicesList = document.getElementById('local-services-list');
                    servicesList.innerHTML = '';
                    
                    if (data.length === 0) {
                        servicesList.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Nessun servizio disponibile. Aggiungi il primo!</div>';
                        return;
                    }
                    
                    // Group by service type
                    const groupedServices = {};
                    data.forEach(service => {
                        const type = service.type || 'other';
                        if (!groupedServices[type]) {
                            groupedServices[type] = [];
                        }
                        groupedServices[type].push(service);
                    });
                    
                    const typeNames = {
                        'restaurant': 'üçΩÔ∏è Ristoranti',
                        'cafe': '‚òï Bar e Caff√®', 
                        'supermarket': 'üõí Supermercati',
                        'pharmacy': 'üíä Farmacie',
                        'attraction': 'üéØ Attrazioni',
                        'transport': 'üöå Trasporti',
                        'other': 'üìç Altri Servizi'
                    };
                    
                    Object.keys(groupedServices).forEach(type => {
                        const section = document.createElement('div');
                        section.className = 'mb-4';
                        section.innerHTML = `
                            <h6 class="border-bottom pb-2">${typeNames[type] || type}</h6>
                            <div class="row" id="services-${type}"></div>
                        `;
                        
                        const servicesContainer = section.querySelector(`#services-${type}`);
                        
                        groupedServices[type].forEach(service => {
                            const serviceCard = document.createElement('div');
                            serviceCard.className = 'col-md-6 mb-3';
                            serviceCard.innerHTML = `
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">${service.name}</h6>
                                            ${service.rating ? `<span class="badge bg-warning">‚≠ê ${service.rating}</span>` : ''}
                                        </div>
                                        <p class="card-text small">${service.description}</p>
                                        ${service.distance ? `<p class="text-muted small"><i class="bi bi-geo-alt"></i> ${service.distance}</p>` : ''}
                                        ${service.phone ? `<p class="text-muted small"><i class="bi bi-telephone"></i> ${service.phone}</p>` : ''}
                                        ${service.hours ? `<p class="text-muted small"><i class="bi bi-clock"></i> ${service.hours}</p>` : ''}
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editLocalService('${service._id}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteLocalService('${service._id}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            ${service.maps_url ? `<a href="${service.maps_url}" target="_blank" class="btn btn-outline-info"><i class="bi bi-map"></i></a>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                            servicesContainer.appendChild(serviceCard);
                        });
                        
                        servicesList.appendChild(section);
                    });
                    
                    // Setup filter listeners
                    document.querySelectorAll('input[name="service-filter"]').forEach(radio => {
                        radio.addEventListener('change', loadLocalServices);
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento servizi:', error);
                    document.getElementById('local-services-list').innerHTML = '<div class="alert alert-danger">Errore nel caricamento dei servizi</div>';
                });
        }
        
        function editLocalService(id) {
            fetch('/admin/api/local-services')
                .then(response => response.json())
                .then(data => {
                    const service = data.find(item => item._id === id);
                    if (service) {
                        document.getElementById('service-id').value = service._id;
                        document.getElementById('service-type').value = service.type;
                        document.getElementById('service-name').value = service.name;
                        document.getElementById('service-description').value = service.description;
                        document.getElementById('service-address').value = service.address || '';
                        document.getElementById('service-distance').value = service.distance || '';
                        document.getElementById('service-phone').value = service.phone || '';
                        document.getElementById('service-rating').value = service.rating || '';
                        document.getElementById('service-hours').value = service.hours || '';
                        document.getElementById('service-maps-url').value = service.maps_url || '';
                        
                        new bootstrap.Modal(document.getElementById('localServiceModal')).show();
                    }
                });
        }
        
        function deleteLocalService(id) {
            if (confirm('Sei sicuro di voler eliminare questo servizio?')) {
                fetch(`/admin/api/local-services/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadLocalServices();
                        showNotification('success', result.message);
                    }
                });
            }
        }

        // Smart Home Functions
        function addSmartDevice() {
            showSmartDeviceModal();
        }
        
        function showSmartDeviceModal(device = null) {
            const modalHtml = `
                <div class="modal fade" id="smartDeviceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${device ? 'Modifica' : 'Aggiungi'} Dispositivo Smart</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="smart-device-form">
                                    <input type="hidden" id="device-id" value="${device?._id || ''}">
                                    <div class="mb-3">
                                        <label for="device-name" class="form-label">Nome Dispositivo</label>
                                        <input type="text" class="form-control" id="device-name" value="${device?.device || ''}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="device-type-select" class="form-label">Tipo</label>
                                        <select class="form-select" id="device-type-select" required>
                                            <option value="">Seleziona tipo...</option>
                                            <option value="lock" ${device?.device_type === 'lock' ? 'selected' : ''}>Serratura Smart (TTLock)</option>
                                            <option value="tv" ${device?.device_type === 'tv' ? 'selected' : ''}>Smart TV</option>
                                            <option value="ac" ${device?.device_type === 'ac' ? 'selected' : ''}>Aria Condizionata</option>
                                            <option value="wifi" ${device?.device_type === 'wifi' ? 'selected' : ''}>WiFi</option>
                                            <option value="appliance" ${device?.device_type === 'appliance' ? 'selected' : ''}>Elettrodomestico</option>
                                            <option value="other" ${device?.device_type === 'other' ? 'selected' : ''}>Altro</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="device-instructions" class="form-label">Istruzioni</label>
                                        <textarea class="form-control" id="device-instructions" rows="5" required>${device?.instructions || ''}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                                <button type="button" class="btn btn-success" onclick="saveSmartDevice()">Salva</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('smartDeviceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('smartDeviceModal')).show();
        }
        
        function saveSmartDevice() {
            const deviceId = document.getElementById('device-id').value;
            const data = {
                device: document.getElementById('device-name').value,
                device_type: document.getElementById('device-type-select').value,
                instructions: document.getElementById('device-instructions').value,
                context_code: currentApartment
            };
            
            if (deviceId) {
                data._id = deviceId;
            }
            
            fetch('/admin/api/smart-home', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('smartDeviceModal')).hide();
                    loadSmartDevices();
                    showNotification('success', result.message);
                } else {
                    showNotification('error', 'Errore nel salvataggio');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showNotification('error', 'Errore di connessione');
            });
        }

        function loadSmartDevices() {
            fetch('/admin/api/smart-home')
                .then(response => response.json())
                .then(data => {
                    const devicesList = document.getElementById('smart-devices-list');
                    devicesList.innerHTML = '';
                    
                    if (data.length === 0) {
                        devicesList.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Nessun dispositivo configurato. Aggiungi il primo!</div>';
                        return;
                    }
                    
                    const devicesContainer = document.createElement('div');
                    devicesContainer.className = 'row';
                    
                    data.forEach(device => {
                        const deviceCard = document.createElement('div');
                        deviceCard.className = 'col-md-6 mb-3';
                        
                        const deviceIcon = device.device_type === 'lock' ? 'üîí' :
                                         device.device_type === 'tv' ? 'üì∫' :
                                         device.device_type === 'ac' ? '‚ùÑÔ∏è' :
                                         device.device_type === 'wifi' ? 'üì∂' :
                                         device.device_type === 'appliance' ? 'üè†' : '‚öôÔ∏è';
                        
                        deviceCard.innerHTML = `
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="card-title">${deviceIcon} ${device.device}</h6>
                                        <span class="badge bg-info">${device.device_type || 'other'}</span>
                                    </div>
                                    <p class="card-text small">${device.instructions.substring(0, 100)}${device.instructions.length > 100 ? '...' : ''}</p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editSmartDevice('${device._id}')">
                                            <i class="bi bi-pencil"></i> Modifica
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSmartDevice('${device._id}')">
                                            <i class="bi bi-trash"></i> Elimina
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        devicesContainer.appendChild(deviceCard);
                    });
                    
                    devicesList.appendChild(devicesContainer);
                })
                .catch(error => {
                    console.error('Errore nel caricamento dispositivi:', error);
                    document.getElementById('smart-devices-list').innerHTML = '<div class="alert alert-danger">Errore nel caricamento dei dispositivi</div>';
                });
        }
        
        function editSmartDevice(id) {
            fetch('/admin/api/smart-home')
                .then(response => response.json())
                .then(data => {
                    const device = data.find(item => item._id === id);
                    if (device) {
                        showSmartDeviceModal(device);
                    }
                });
        }
        
        function deleteSmartDevice(id) {
            if (confirm('Sei sicuro di voler eliminare questo dispositivo?')) {
                fetch(`/admin/api/smart-home/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadSmartDevices();
                        showNotification('success', result.message);
                    }
                });
            }
        }

        // Conversations Functions
        function loadConversations() {
            fetch('/admin/api/conversations?context=apt_brescia&limit=20')
                .then(response => response.json())
                .then(data => {
                    const conversationsList = document.getElementById('conversations-list');
                    conversationsList.innerHTML = '';
                    
                    if (data.length === 0) {
                        conversationsList.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Nessuna conversazione recente</div>';
                        return;
                    }
                    
                    data.forEach(conversation => {
                        const conversationCard = document.createElement('div');
                        conversationCard.className = 'card mb-3';
                        
                        const lastMessage = conversation.messages && conversation.messages.length > 0 ? 
                                          conversation.messages[conversation.messages.length - 1] : null;
                        
                        const lastUpdate = new Date(conversation.last_updated).toLocaleString('it-IT');
                        
                        conversationCard.innerHTML = `
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-title">Utente: ${conversation.sender_id.substring(0, 10)}...</h6>
                                    <span class="badge bg-secondary">${lastUpdate}</span>
                                </div>
                                ${lastMessage ? `
                                    <p class="card-text"><strong>Ultimo messaggio:</strong> ${lastMessage.content.substring(0, 100)}${lastMessage.content.length > 100 ? '...' : ''}</p>
                                ` : '<p class="card-text text-muted">Conversazione senza messaggi</p>'}
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">${conversation.context || 'sconosciuto'}</span>
                                    <small class="text-muted">${conversation.messages ? conversation.messages.length : 0} messaggi</small>
                                </div>
                            </div>
                        `;
                        conversationsList.appendChild(conversationCard);
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento conversazioni:', error);
                    document.getElementById('conversations-list').innerHTML = '<div class="alert alert-danger">Errore nel caricamento delle conversazioni</div>';
                });
        }
        
        // Utility Functions
        function showNotification(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert:last-of-type');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 3000);
        }
    </script>
</body>
</html> 